# Configuration settings
box = "debian/bookworm64"
memory = 8192
cpus = 2
master_ip = "192.168.56.20"
master_host = "k3s-master"
agent_ip = "192.168.56.30"
agent_host = "k3s-agent"
# VMs
Vagrant.configure("2") do |config|
  config.vm.box = box
  config.vm.synced_folder "./shared", "/vagrant"
  config.vm.provider "virtualbox" do |vb|
    vb.memory = memory
    vb.cpus = cpus
  end
  config.vm.define "k3s-master" do |master|
    master.vm.box = box
    master.vm.hostname = master_host
    master.vm.network "private_network",
      ip: master_ip,
      hostname: master_host
    master.vm.network "forwarded_port", guest: 6443, host: 6443
    master.vm.provision :shell, inline: <<-SHELL
        sudo DEBIAN_FRONTEND=noninteractive apt-get update -y && sudo apt-get install curl -y
        export FLAGS="--tls-san #{master_ip} --node-ip #{master_ip} --node-external-ip #{master_ip}"
        curl -sfL https://get.k3s.io | INSTALL_K3S_EXEC="$FLAGS" K3S_NODE_NAME="#{master_host}" K3S_KUBECONFIG_MODE="644" sh -
        K3S_TOKEN=$(sudo cat /var/lib/rancher/k3s/server/token)
        echo "export K3S_TOKEN=$K3S_TOKEN" > /vagrant/node-token
        sudo cp /etc/rancher/k3s/k3s.yaml /vagrant/k3s.yaml
    SHELL
  end
  config.vm.define "k3s-agent" do |agent|
    agent.vm.hostname = agent_host
    agent.vm.network "private_network",
      ip: agent_ip,
      hostname: agent_host
    agent.vm.network "forwarded_port", guest: 3000, host: 3000
    agent.vm.network "forwarded_port", guest: 30000, host: 30000
    agent.vm.provision :shell, inline: <<-SHELL
    sudo DEBIAN_FRONTEND=noninteractive apt-get update -y && sudo apt-get install curl -y
    while [ ! -f /vagrant/node-token ]; do
      echo "Waiting for master to configure..."
    sleep 5
    done
    echo "Found node-token file. Proceeding with k3s agent setup."
    source /vagrant/node-token
    export FLAGS="--node-ip #{agent_ip} --node-external-ip #{agent_ip}"
    echo "Joining the k3s cluster..."
    curl -sfL https://get.k3s.io | INSTALL_K3S_EXEC="$FLAGS" K3S_NODE_NAME="#{agent_host}" K3S_URL="https://#{master_ip}:6443" K3S_TOKEN=$K3S_TOKEN sh -
    SHELL
  end
end
